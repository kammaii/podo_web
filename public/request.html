<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>요청조회</title>
    <style>
      .menus, .listClass{
        display: flex;
        justify-content: space-around;
        border-bottom: 1px solid grey;
      }
      #tg  {border-collapse:collapse;border-spacing:0;border-color:#ccc;}
      #tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#ccc;color:#333;background-color:#fff;}
      #tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#ccc;color:#333;background-color:#f0f0f0;}
      #tg {text-align:left;vertical-align:middle}
    </style>
  </head>
  <body>
    <h1>요청조회</h1>
    <input type="radio" name="request" checked> 교정요청
    <input type="radio" name="request"> 녹음요청
    <input type="checkbox" id="searchAll" name="searchAll"> 전체
    <br><br>
    학생이메일 검색: <input id="searchEmail" value=""/> <br>
    상태 검색:
    <input type="radio" name="status"> 검토중
    <input type="radio" name="status"> 교정완료
    <input type="radio" name="status"> 거부됨
    <input type="button" value="검색" onclick="search()">
    <br><br>
    <div class="tg-wrap">
      <table id="tg">
        <tr>
          <th>상세보기</th>
          <th>번호</th>
          <th>GUID</th>
          <th>내용</th>
          <th>학생이메일</th>
          <th>요청날짜</th>
          <th>완료날짜</th>
          <th>상태</th>
          <th>담당</th>
        </tr>
      </table>
    </div>

    <script src="https://www.gstatic.com/firebasejs/7.6.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.0/firebase-firestore.js"></script>
    <script src="firebaseinit.js"></script>
    <script src="getExtra.js"></script>

    <script>
      var tbody;
      var row;
      var no = 0;

      var reference;

      // 검색하기
      function search() {
        var request = document.getElementsByName('request');
        var searchAll = document.getElementById('searchAll');

        // 교정요청, 녹음요청 선택
        if(request[0].checked) {
          console.log("교정요청");
          reference = db.collection("android/podo/writings").where("teacherName", "==", getExtra);
        } else if(request[1].checked) {
          console.log("녹음요청");
          reference = db.collection("android/podo/collections").where("teacherName", "==", getExtra);
        }

        // 전체 선택
        if(searchAll.checked) {
          if(request[0].checked) {
            console.log("교정요청 + 전체체크");
            reference = db.collection("android/podo/writings");
          } else if(request[1].checked) {
            console.log("녹음요청 + 전체체크");
            reference = db.collection("android/podo/collections");
          }
        }

        // 학생이메일 검색
        var searchEmail = document.getElementById("searchEmail").value;
        if(searchEmail != "") {
          if(request[0].checked) {
            console.log("교정요청 + 학생이메일");
            reference.where("userEmail", "==", searchEmail);
          } else if(request[1].checked) {
            console.log("녹음요청 + 학생이메일");
            reference.where("userEmail", "==", searchEmail);
          }
        }

        // 상태 검색
        var status = document.getElementsByName('status');
        var statusId;
        for(var i=0; i<3; i++) {
          if(status[i].checked) {
            if(i == 0) {
              statusId = 1;
            } else if(i == 1) {
              statusId = 2;
            } else if(i ==2) {
              statusId = 3;
            }
            if(request[0].checked) {
              console.log("교정요청+"+statusId);
              reference.where("isCorrected", "==", statusId);
            } else if(request[1].checked) {
              console.log("녹음요청+"+statusId);
              reference.where("isRecorded", "==", statusId);
            }
          }
        }

        for(let i=0; i<no; i++) {
          let item = document.getElementById('row' + i);
          item.innerHTML = "";
        }
        no = 0;
        getItems();
      }


      // 상세정보페이지에 학생이름이랑 guid 넘기기
      function nextPage(guid) {
        var newWindow = window.open("about:blank");
        newWindow.location.href="/req_correction_detail.html?guid=" + guid;
      }


      // DB에서 아이템 가져오기
      function getItems() {
        reference.get().then(function(querySnapshot) {
          querySnapshot.forEach(function(doc) {
            let data = doc.data();
            tbody = document.getElementById('tg');
            row = tbody.insertRow(-1);
            row.id = "row" + no;

            let selectItem = row.insertCell(0)
            let requestNo = row.insertCell(1);
            let guidNo = row.insertCell(2);
            let article = row.insertCell(3);
            let studentEmail = row.insertCell(4);
            let requestDate = row.insertCell(5);
            let completeDate = row.insertCell(6);
            let status = row.insertCell(7);
            let teacherName = row.insertCell(8);
            let guid = data.guid;
            selectItem.innerHTML = "<input type='button' onclick=\"nextPage('" + guid + "')\">";

            requestNo.innerHTML = no;
            guidNo.innerHTML = guid.substring(0,8)+"...";
            article.innerHTML = data.article.substring(0,30)+"...";
            studentEmail.innerHTML = data.userEmail;
            requestDate.innerHTML = data.dateRequest;
            completeDate.innerHTML = data.dateCorrection;
            if(data.isCorrected == 1) {
              status.innerHTML = "신규";
            }else if(data.isCorrected == 2) {
              status.innerHTML = "완료";
            }else if(data.isCorrected == 3) {
              status.innerHTML = "거부";
            }
            teacherName.innerHTML = data.teacherName;
            no++;
          })
        })
      }
    </script>
  </body>
</html>
